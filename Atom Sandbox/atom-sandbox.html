<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Atom Sandbox</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
<style>
body {
margin: 0;
padding: 20px;
font-family: Arial, sans-serif;
background-color: #f0f0f0;
}
#playarea {
border: 2px solid #333;
background-color: #ffffff;
cursor: crosshair;
}
#spawn-button {
margin-bottom: 10px;
padding: 10px 20px;
font-size: 16px;
cursor: pointer;
background-color: #4CAF50;
color: white;
border: none;
border-radius: 4px;
}
#periodic-table-modal {
display: none;
position: fixed;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
padding: 20px;
border: 2px solid #333;
border-radius: 8px;
background-color: #ffffff;
z-index: 1000;
width: 80%;
max-width: 1000px;
max-height: 80vh;
overflow-y: auto;
}
.element-button {
    width: 60px;
    height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    border: 1px solid #ccc;
    border-radius: 4px;
    margin: 2px;
    cursor: pointer;
    font-size: 12px;
    background-color: #e0e0e0;
    transition: background-color 0.2s;
}

.element-button:hover {
    background-color: #d0d0d0;
}

.element-symbol {
    font-size: 18px;
    font-weight: bold;
}

.element-number {
    font-size: 10px;
}

.element-button.empty {
    visibility: hidden;
    pointer-events: none;
}

#periodic-table-grid {
    display: grid;
    grid-template-columns: repeat(18, 1fr);
    gap: 5px;
    margin-top: 10px;
}

#isotope-selection {
    margin-top: 20px;
    border-top: 1px solid #eee;
    padding-top: 15px;
}

#isotope-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-top: 10px;
}

.isotope-button {
    padding: 8px 12px;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    background-color: #f0f0f0;
    transition: background-color 0.2s;
}

.isotope-button:hover {
    background-color: #e0e0e0;
}

#back-to-elements {
    margin-top: 15px;
    padding: 8px 15px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

#back-to-elements:hover {
    background-color: #0056b3;
}

</style>
</head>
<body>
<button id="spawn-button">Spawn Atom</button>
<button id="pause-button">Pause</button>
<button id="reset-button">Reset</button>
<canvas id="playarea" width="1200" height="800"></canvas>
<div id="periodic-table-modal">
<h2>Select Stable Element</h2>
<div id="periodic-table-grid">
    <!-- Elements will be dynamically loaded here -->
</div>

</div>
<script>
const spawnButton = document.getElementById('spawn-button');
const periodicTableModal = document.getElementById('periodic-table-modal');
const playarea = document.getElementById('playarea');
const ctx = playarea.getContext('2d');

const resetButton = document.getElementById('reset-button');

resetButton.addEventListener('click', () => {
    // Remove all bodies from the Matter.js world except the walls
    World.remove(world, mouseConstraint);
    World.clear(world, false);
    // Re-add walls
    const wallThickness = 50;
    World.add(world, [
        Bodies.rectangle(playarea.width / 2, -wallThickness / 2, playarea.width, wallThickness, { isStatic: true }),
        Bodies.rectangle(playarea.width / 2, playarea.height + wallThickness / 2, playarea.width, wallThickness, { isStatic: true }),
        Bodies.rectangle(-wallThickness / 2, playarea.height / 2, wallThickness, playarea.height, { isStatic: true }),
        Bodies.rectangle(playarea.width + wallThickness / 2, playarea.height / 2, wallThickness, playarea.height, { isStatic: true })
    ]);
    World.add(world, mouseConstraint);
    atoms = []; // Clear the atoms array
    radioactiveParticles = []; // Clear the radioactive particles array
});

let isPaused = false;

// Sound effects
const collisionSound = new Audio('sounds/atom_bonding.mp3');
collisionSound.volume = 0.7;
const decaySound = new Audio('sounds/radioactive_decay.mp3');
decaySound.volume = 0.5;
const unbondSound = new Audio('sounds/atom_unbonding.mp3');
unbondSound.volume = 0.7;
const pauseButton = document.getElementById('pause-button');
pauseButton.addEventListener('click', () => {
    isPaused = !isPaused;
    pauseButton.textContent = isPaused ? 'Play' : 'Pause';
});

// Matter.js module aliases
const Engine = Matter.Engine,
    Render = Matter.Render,
    World = Matter.World,
    Bodies = Matter.Bodies,
    Mouse = Matter.Mouse,
    MouseConstraint = Matter.MouseConstraint;

// Create a Matter.js engine
const engine = Engine.create();
engine.world.gravity.y = 0; // Disable gravity
const world = engine.world;

Matter.Events.on(engine, 'collisionStart', function(event) {
    const pairs = event.pairs;

    for (let i = 0; i < pairs.length; i++) {
        const pair = pairs[i];

        const bodyA = pair.bodyA;
        const bodyB = pair.bodyB;

        // Check for radioactive particle collision
        if (bodyA.particleObject && bodyB.atomObject) {
            handleRadioactiveCollision(bodyB.atomObject, bodyA.particleObject);
            continue; // Skip further processing for this pair
        } else if (bodyB.particleObject && bodyA.atomObject) {
            handleRadioactiveCollision(bodyA.atomObject, bodyB.particleObject);
            continue; // Skip further processing for this pair
        }

        // Check if both bodies are atoms (assuming atoms have a 'atomObject' property)
        if (bodyA.atomObject && bodyB.atomObject) {
            const atomA = bodyA.atomObject;
            const atomB = bodyB.atomObject;

            // Attempt to bond atoms
            bondAtoms(atomA, atomB);
        }
    }
});

// Create a Matter.js renderer (optional, we'll draw manually)
// const render = Render.create({
//     element: document.body,
//     engine: engine,
// //     canvas: playarea,
//     options: {
//         width: playarea.width,
//         height: playarea.height,
//         wireframes: false // Show textures
//     }
// });
// Render.run(render);

// Add walls to the world
const wallThickness = 50;
World.add(world, [
    // Top wall
    Bodies.rectangle(playarea.width / 2, -wallThickness / 2, playarea.width, wallThickness, { isStatic: true }),
    // Bottom wall
    Bodies.rectangle(playarea.width / 2, playarea.height + wallThickness / 2, playarea.width, wallThickness, { isStatic: true }),
    // Left wall
    Bodies.rectangle(-wallThickness / 2, playarea.height / 2, wallThickness, playarea.height, { isStatic: true }),
    // Right wall
    Bodies.rectangle(playarea.width + wallThickness / 2, playarea.height / 2, wallThickness, playarea.height, { isStatic: true })
]);

// Add mouse control
const mouse = Mouse.create(playarea);
const mouseConstraint = MouseConstraint.create(engine, {
    mouse: mouse,
    constraint: {
        stiffness: 0.2,
        render: {
            visible: false
        }
    }
});
World.add(world, mouseConstraint);

// Keep the mouse in sync with the canvas
mouse.element.removeEventListener("mousewheel", mouse.mousewheel);
mouse.element.removeEventListener("DOMMouseScroll", mouse.DOMMouseScroll);

let atoms = [];
let radioactiveParticles = [];
const atomCategory = 0x0001;
const particleCategory = 0x0002;
let lastCanvasClick = { x: playarea.width / 2, y: playarea.height / 2 }; // Always spawn in center

spawnButton.addEventListener('click', () => {
periodicTableModal.style.display = 'block';
});

// Close modal when clicking outside
window.addEventListener('click', (e) => {
if (e.target === periodicTableModal) {
periodicTableModal.style.display = 'none';
document.getElementById('periodic-table-grid').style.display = 'grid';
document.getElementById('isotope-selection').style.display = 'none';
}
});





    playarea.addEventListener('click', function(event) {
        const mouseX = event.clientX - playarea.getBoundingClientRect().left;
        const mouseY = event.clientY - playarea.getBoundingClientRect().top;

        // First, check for bond clicks (unbonding)
        for (const atom of atoms) {
            for (let i = 0; i < atom.bondedTo.length; i++) {
                const bond = atom.bondedTo[i];
                const otherAtom = bond.atom;

                const midX = (atom.body.position.x + otherAtom.body.position.x) / 2;
                const midY = (atom.body.position.y + otherAtom.body.position.y) / 2;

                const distanceToBond = Math.sqrt(Math.pow(mouseX - midX, 2) + Math.pow(mouseY - midY, 2));
                const BOND_CLICK_TOLERANCE = 2; // Pixels

                if (distanceToBond < BOND_CLICK_TOLERANCE) {
                    unbondAtoms(atom, otherAtom);
                    selectedAtomForBonding = null; // Deselect any atom if a bond is broken
                    return; // Bond broken, stop further processing
                }
            }
        }
    });





const elements = [
    { name: 'Hydrogen', symbol: 'H', atomicNumber: 1, stableIsotopes: [1], color: '#ADD8E6', maxBonds: 1 },
    { name: 'Helium', symbol: 'He', atomicNumber: 2, stableIsotopes: [4], color: '#FFD700', maxBonds: 0 },
    { name: 'Lithium', symbol: 'Li', atomicNumber: 3, stableIsotopes: [7], color: '#FF69B4', maxBonds: 1 },
    { name: 'Beryllium', symbol: 'Be', atomicNumber: 4, stableIsotopes: [9], color: '#9ACD32', maxBonds: 2 },
    { name: 'Boron', symbol: 'B', atomicNumber: 5, stableIsotopes: [11], color: '#FFB6C1', maxBonds: 3 },
    { name: 'Carbon', symbol: 'C', atomicNumber: 6, stableIsotopes: [12], color: '#808080', maxBonds: 4 },
    { name: 'Nitrogen', symbol: 'N', atomicNumber: 7, stableIsotopes: [14], color: '#87CEEB', maxBonds: 3 },
    { name: 'Oxygen', symbol: 'O', atomicNumber: 8, stableIsotopes: [16], color: '#FF0000', maxBonds: 2 },
    { name: 'Fluorine', symbol: 'F', atomicNumber: 9, stableIsotopes: [19], color: '#FFFF00', maxBonds: 1 },
    { name: 'Neon', symbol: 'Ne', atomicNumber: 10, stableIsotopes: [20], color: '#ADFF2F', maxBonds: 0 },
    { name: 'Sodium', symbol: 'Na', atomicNumber: 11, stableIsotopes: [23], color: '#FFA07A', maxBonds: 1 },
    { name: 'Magnesium', symbol: 'Mg', atomicNumber: 12, stableIsotopes: [24], color: '#7FFFD4', maxBonds: 2 },
    { name: 'Aluminum', symbol: 'Al', atomicNumber: 13, stableIsotopes: [27], color: '#C0C0C0', maxBonds: 3 },
    { name: 'Silicon', symbol: 'Si', atomicNumber: 14, stableIsotopes: [28], color: '#DA70D6', maxBonds: 4 },
    { name: 'Phosphorus', symbol: 'P', atomicNumber: 15, stableIsotopes: [31], color: '#FFA500', maxBonds: 3 },
    { name: 'Sulfur', symbol: 'S', atomicNumber: 16, stableIsotopes: [32], color: '#FFD700', maxBonds: 2 },
    { name: 'Chlorine', symbol: 'Cl', atomicNumber: 17, stableIsotopes: [35], color: '#00FF00', maxBonds: 1 },
    { name: 'Argon', symbol: 'Ar', atomicNumber: 18, stableIsotopes: [40], color: '#BA55D3', maxBonds: 0 },
    { name: 'Potassium', symbol: 'K', atomicNumber: 19, stableIsotopes: [39], color: '#EE82EE', maxBonds: 1 },
    { name: 'Calcium', symbol: 'Ca', atomicNumber: 20, stableIsotopes: [40], color: '#8B0000', maxBonds: 2 },
    { name: 'Scandium', symbol: 'Sc', atomicNumber: 21, stableIsotopes: [45], color: '#4682B4', maxBonds: 3 },
    { name: 'Titanium', symbol: 'Ti', atomicNumber: 22, stableIsotopes: [48], color: '#6A5ACD', maxBonds: 4 },
    { name: 'Vanadium', symbol: 'V', atomicNumber: 23, stableIsotopes: [51], color: '#A52A2A', maxBonds: 5 },
    { name: 'Chromium', symbol: 'Cr', atomicNumber: 24, stableIsotopes: [52], color: '#B22222', maxBonds: 3 },
    { name: 'Manganese', symbol: 'Mn', atomicNumber: 25, stableIsotopes: [55], color: '#800000', maxBonds: 2 },
    { name: 'Iron', symbol: 'Fe', atomicNumber: 26, stableIsotopes: [56], color: '#A0522D', maxBonds: 3 },
    { name: 'Cobalt', symbol: 'Co', atomicNumber: 27, stableIsotopes: [59], color: '#0000CD', maxBonds: 2 },
    { name: 'Nickel', symbol: 'Ni', atomicNumber: 28, stableIsotopes: [58], color: '#5F9EA0', maxBonds: 2 },
    { name: 'Copper', symbol: 'Cu', atomicNumber: 29, stableIsotopes: [63], color: '#B8860B', maxBonds: 1 },
    { name: 'Zinc', symbol: 'Zn', atomicNumber: 30, stableIsotopes: [64], color: '#BDB76B', maxBonds: 2 },
    { name: 'Gallium', symbol: 'Ga', atomicNumber: 31, stableIsotopes: [69], color: '#C71585', maxBonds: 3 },
    { name: 'Germanium', symbol: 'Ge', atomicNumber: 32, stableIsotopes: [74], color: '#FF6347', maxBonds: 4 },
    { name: 'Arsenic', symbol: 'As', atomicNumber: 33, stableIsotopes: [75], color: '#8B008B', maxBonds: 3 },
    { name: 'Selenium', symbol: 'Se', atomicNumber: 34, stableIsotopes: [80], color: '#CD5C5C', maxBonds: 2 },
    { name: 'Bromine', symbol: 'Br', atomicNumber: 35, stableIsotopes: [79], color: '#A52A2A', maxBonds: 1 },
    { name: 'Krypton', symbol: 'Kr', atomicNumber: 36, stableIsotopes: [84], color: '#483D8B', maxBonds: 0 },
    { name: 'Rubidium', symbol: 'Rb', atomicNumber: 37, stableIsotopes: [85], color: '#8B0000', maxBonds: 1 },
    { name: 'Strontium', symbol: 'Sr', atomicNumber: 38, stableIsotopes: [88], color: '#DC143C', maxBonds: 2 },
    { name: 'Yttrium', symbol: 'Y', atomicNumber: 39, stableIsotopes: [89], color: '#00BFFF', maxBonds: 3 },
    { name: 'Zirconium', symbol: 'Zr', atomicNumber: 40, stableIsotopes: [90], color: '#2F4F4F', maxBonds: 4 },
    { name: 'Niobium', symbol: 'Nb', atomicNumber: 41, stableIsotopes: [93], color: '#696969', maxBonds: 5 },
    { name: 'Molybdenum', symbol: 'Mo', atomicNumber: 42, stableIsotopes: [98], color: '#708090', maxBonds: 6 },
    { name: 'Technetium', symbol: 'Tc', atomicNumber: 43, stableIsotopes: [98], color: '#D3D3D3', maxBonds: 7, halfLife: 5000 },
    { name: 'Ruthenium', symbol: 'Ru', atomicNumber: 44, stableIsotopes: [102], color: '#808080', maxBonds: 4 },
    { name: 'Rhodium', symbol: 'Rh', atomicNumber: 45, stableIsotopes: [103], color: '#C0C0C0', maxBonds: 3 },
    { name: 'Palladium', symbol: 'Pd', atomicNumber: 46, stableIsotopes: [106], color: '#D3D3D3', maxBonds: 2 },
    { name: 'Silver', symbol: 'Ag', atomicNumber: 47, stableIsotopes: [107], color: '#C0C0C0', maxBonds: 1 },
    { name: 'Cadmium', symbol: 'Cd', atomicNumber: 48, stableIsotopes: [114], color: '#FFD700', maxBonds: 2 },
    { name: 'Indium', symbol: 'In', atomicNumber: 49, stableIsotopes: [115], color: '#A0522D', maxBonds: 3 },
    { name: 'Tin', symbol: 'Sn', atomicNumber: 50, stableIsotopes: [120], color: '#B0C4DE', maxBonds: 4 },
    { name: 'Antimony', symbol: 'Sb', atomicNumber: 51, stableIsotopes: [121], color: '#DAA520', maxBonds: 3 },
    { name: 'Tellurium', symbol: 'Te', atomicNumber: 52, stableIsotopes: [130], color: '#D2B48C', maxBonds: 2 },
    { name: 'Iodine', symbol: 'I', atomicNumber: 53, stableIsotopes: [127], color: '#9932CC', maxBonds: 1 },
    { name: 'Xenon', symbol: 'Xe', atomicNumber: 54, stableIsotopes: [132], color: '#4B0082', maxBonds: 0 },
    { name: 'Cesium', symbol: 'Cs', atomicNumber: 55, stableIsotopes: [133], color: '#8B0000', maxBonds: 1 },
    { name: 'Barium', symbol: 'Ba', atomicNumber: 56, stableIsotopes: [138], color: '#006400', maxBonds: 2 },
    { name: 'Lanthanum', symbol: 'La', atomicNumber: 57, stableIsotopes: [139], color: '#48D1CC', maxBonds: 3 },
    { name: 'Cerium', symbol: 'Ce', atomicNumber: 58, stableIsotopes: [140], color: '#B0E0E6', maxBonds: 3 },
    { name: 'Praseodymium', symbol: 'Pr', atomicNumber: 59, stableIsotopes: [141], color: '#AFEEEE', maxBonds: 3 },
    { name: 'Neodymium', symbol: 'Nd', atomicNumber: 60, stableIsotopes: [142], color: '#87CEFA', maxBonds: 3 },
    { name: 'Promethium', symbol: 'Pm', atomicNumber: 61, stableIsotopes: [145], color: '#6495ED', maxBonds: 3, halfLife: 3000 },
    { name: 'Samarium', symbol: 'Sm', atomicNumber: 62, stableIsotopes: [152], color: '#4169E1', maxBonds: 3 },
    { name: 'Europium', symbol: 'Eu', atomicNumber: 63, stableIsotopes: [153], color: '#0000FF', maxBonds: 3 },
    { name: 'Gadolinium', symbol: 'Gd', atomicNumber: 64, stableIsotopes: [158], color: '#191970', maxBonds: 3 },
    { name: 'Terbium', symbol: 'Tb', atomicNumber: 65, stableIsotopes: [159], color: '#00008B', maxBonds: 3 },
    { name: 'Dysprosium', symbol: 'Dy', atomicNumber: 66, stableIsotopes: [164], color: '#000080', maxBonds: 3 },
    { name: 'Holmium', symbol: 'Ho', atomicNumber: 67, stableIsotopes: [165], color: '#8A2BE2', maxBonds: 3 },
    { name: 'Erbium', symbol: 'Er', atomicNumber: 68, stableIsotopes: [166], color: '#4B0082', maxBonds: 3 },
    { name: 'Thulium', symbol: 'Tm', atomicNumber: 69, stableIsotopes: [169], color: '#800080', maxBonds: 3 },
    { name: 'Ytterbium', symbol: 'Yb', atomicNumber: 70, stableIsotopes: [174], color: '#9400D3', maxBonds: 3 },
    { name: 'Lutetium', symbol: 'Lu', atomicNumber: 71, stableIsotopes: [175], color: '#FF00FF', maxBonds: 3 },
    { name: 'Hafnium', symbol: 'Hf', atomicNumber: 72, stableIsotopes: [180], color: '#DDA0DD', maxBonds: 4 },
    { name: 'Tantalum', symbol: 'Ta', atomicNumber: 73, stableIsotopes: [181], color: '#BA55D3', maxBonds: 5 },
    { name: 'Tungsten', symbol: 'W', atomicNumber: 74, stableIsotopes: [184], color: '#4B0082', maxBonds: 6 },
    { name: 'Rhenium', symbol: 'Re', atomicNumber: 75, stableIsotopes: [187], color: '#800080', maxBonds: 7 },
    { name: 'Osmium', symbol: 'Os', atomicNumber: 76, stableIsotopes: [192], color: '#6A5ACD', maxBonds: 4 },
    { name: 'Iridium', symbol: 'Ir', atomicNumber: 77, stableIsotopes: [193], color: '#483D8B', maxBonds: 3 },
    { name: 'Platinum', symbol: 'Pt', atomicNumber: 78, stableIsotopes: [195], color: '#D3D3D3', maxBonds: 2 },
    { name: 'Gold', symbol: 'Au', atomicNumber: 79, stableIsotopes: [197], color: '#FFD700', maxBonds: 3 },
    { name: 'Mercury', symbol: 'Hg', atomicNumber: 80, stableIsotopes: [202], color: '#C0C0C0', maxBonds: 2 },
    { name: 'Thallium', symbol: 'Tl', atomicNumber: 81, stableIsotopes: [205], color: '#A9A9A9', maxBonds: 1 },
    { name: 'Lead', symbol: 'Pb', atomicNumber: 82, stableIsotopes: [208], color: '#696969', maxBonds: 2 },
    { name: 'Bismuth', symbol: 'Bi', atomicNumber: 83, stableIsotopes: [209], color: '#808080', maxBonds: 3, halfLife: 30000 },
    { name: 'Polonium', symbol: 'Po', atomicNumber: 84, stableIsotopes: [209], color: '#CD5C5C', maxBonds: 2, halfLife: 3000 },
    { name: 'Astatine', symbol: 'At', atomicNumber: 85, stableIsotopes: [210], color: '#A52A2A', maxBonds: 1, halfLife: 1000 },
    { name: 'Radon', symbol: 'Rn', atomicNumber: 86, stableIsotopes: [222], color: '#483D8B', maxBonds: 0, halfLife: 2000 },
    { name: 'Francium', symbol: 'Fr', atomicNumber: 87, stableIsotopes: [223], color: '#8B0000', maxBonds: 1, halfLife: 1000 },
    { name: 'Radium', symbol: 'Ra', atomicNumber: 88, stableIsotopes: [226], color: '#DC143C', maxBonds: 2, halfLife: 5000 },
    { name: 'Actinium', symbol: 'Ac', atomicNumber: 89, stableIsotopes: [227], color: '#00BFFF', maxBonds: 3, halfLife: 5000 },
    { name: 'Thorium', symbol: 'Th', atomicNumber: 90, stableIsotopes: [232], color: '#2F4F4F', maxBonds: 4, halfLife: 10000 },
    { name: 'Protactinium', symbol: 'Pa', atomicNumber: 91, stableIsotopes: [231], color: '#696969', maxBonds: 5, halfLife: 5000 },
    { name: 'Uranium', symbol: 'U', atomicNumber: 92, stableIsotopes: [238], color: '#708090', maxBonds: 6, halfLife: 10000 },
    { name: 'Neptunium', symbol: 'Np', atomicNumber: 93, stableIsotopes: [237], color: '#ADD8E6', maxBonds: 3, halfLife: 1000 },
    { name: 'Plutonium', symbol: 'Pu', atomicNumber: 94, stableIsotopes: [244], color: '#FFD700', maxBonds: 3, halfLife: 5000 },
    { name: 'Americium', symbol: 'Am', atomicNumber: 95, stableIsotopes: [243], color: '#FF69B4', maxBonds: 3, halfLife: 5000 },
    { name: 'Curium', symbol: 'Cm', atomicNumber: 96, stableIsotopes: [247], color: '#9ACD32', maxBonds: 3, halfLife: 1000 },
    { name: 'Berkelium', symbol: 'Bk', atomicNumber: 97, stableIsotopes: [247], color: '#808080', maxBonds: 3, halfLife: 1000 },
    { name: 'Californium', symbol: 'Cf', atomicNumber: 98, stableIsotopes: [251], color: '#87CEEB', maxBonds: 3, halfLife: 1000 },
    { name: 'Einsteinium', symbol: 'Es', atomicNumber: 99, stableIsotopes: [252], color: '#FF0000', maxBonds: 3, halfLife: 1000 },
    { name: 'Fermium', symbol: 'Fm', atomicNumber: 100, stableIsotopes: [257], color: '#C0C0C0', maxBonds: 3, halfLife: 1000 },
    { name: 'Mendelevium', symbol: 'Md', atomicNumber: 101, stableIsotopes: [258], color: '#A0522D', maxBonds: 3, halfLife: 1000 },
    { name: 'Nobelium', symbol: 'No', atomicNumber: 102, stableIsotopes: [259], color: '#00BFFF', maxBonds: 3, halfLife: 1000 },
    { name: 'Lawrencium', symbol: 'Lr', atomicNumber: 103, stableIsotopes: [262], color: '#2F4F4F', maxBonds: 3, halfLife: 1000 },
    { name: 'Rutherfordium', symbol: 'Rf', atomicNumber: 104, stableIsotopes: [261], color: '#696969', maxBonds: 3, halfLife: 500 },
    { name: 'Dubnium', symbol: 'Db', atomicNumber: 105, stableIsotopes: [262], color: '#BA55D3', maxBonds: 3, halfLife: 500 },
    { name: 'Seaborgium', symbol: 'Sg', atomicNumber: 106, stableIsotopes: [266], color: '#DC143C', maxBonds: 3, halfLife: 500 },
    { name: 'Bohrium', symbol: 'Bh', atomicNumber: 107, stableIsotopes: [264], color: '#4B0082', maxBonds: 3, halfLife: 500 },
    { name: 'Hassium', symbol: 'Hs', atomicNumber: 108, stableIsotopes: [269], color: '#ADD8E6', maxBonds: 3, halfLife: 500 },
    { name: 'Meitnerium', symbol: 'Mt', atomicNumber: 109, stableIsotopes: [278], color: '#FFD700', maxBonds: 3, halfLife: 500 },
    { name: 'Darmstadtium', symbol: 'Ds', atomicNumber: 110, stableIsotopes: [281], color: '#FF69B4', maxBonds: 3, halfLife: 500 },
    { name: 'Roentgenium', symbol: 'Rg', atomicNumber: 111, stableIsotopes: [282], color: '#9ACD32', maxBonds: 3, halfLife: 500 },
    { name: 'Copernicium', symbol: 'Cn', atomicNumber: 112, stableIsotopes: [285], color: '#808080', maxBonds: 3, halfLife: 500 },
    { name: 'Nihonium', symbol: 'Nh', atomicNumber: 113, stableIsotopes: [286], color: '#87CEEB', maxBonds: 3, halfLife: 500 },
    { name: 'Flerovium', symbol: 'Fl', atomicNumber: 114, stableIsotopes: [289], color: '#FF0000', maxBonds: 3, halfLife: 500 },
    { name: 'Moscovium', symbol: 'Mc', atomicNumber: 115, stableIsotopes: [290], color: '#C0C0C0', maxBonds: 3, halfLife: 500 },
    { name: 'Livermorium', symbol: 'Lv', atomicNumber: 116, stableIsotopes: [293], color: '#A0522D', maxBonds: 3, halfLife: 500 },
    { name: 'Tennessine', symbol: 'Ts', atomicNumber: 117, stableIsotopes: [294], color: '#00BFFF', maxBonds: 3, halfLife: 500 },
    { name: 'Oganesson', symbol: 'Og', atomicNumber: 118, stableIsotopes: [294], color: '#2F4F4F', maxBonds: 3, halfLife: 500 }
];



const periodicTableGrid = document.getElementById('periodic-table-grid');
const isotopeSelection = document.getElementById('isotope-selection');
const selectedElementName = document.getElementById('selected-element-name');
const isotopeList = document.getElementById('isotope-list');
const backToElementsButton = document.getElementById('back-to-elements');

const periodicTableLayout = [
    1, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, null, 2,
    3, 4, null, null, null, null, null, null, null, null, null, null, 5, 6, 7, 8, 9, 10,
    11, 12, null, null, null, null, null, null, null, null, null, null, 13, 14, 15, 16, 17, 18,
    19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36,
    37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54,
    55, 56, null, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, 84, 85, 86,
    87, 88, null, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118,
    // Lanthanides
    null, null, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, null,
    // Actinides
    null, null, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, null
];

function renderElements() {
    periodicTableGrid.innerHTML = '';
    const elementsMap = new Map(elements.map(el => [el.atomicNumber, el]));

    periodicTableLayout.forEach(atomicNumber => {
        if (atomicNumber === null) {
            const emptyDiv = document.createElement('div');
            emptyDiv.classList.add('element-button', 'empty');
            periodicTableGrid.appendChild(emptyDiv);
        } else {
            const element = elementsMap.get(atomicNumber);
            if (element) {
                const elementButton = document.createElement('div');
                elementButton.classList.add('element-button');
                elementButton.innerHTML = `
                    <div class="element-number">${element.atomicNumber}</div>
                    <div class="element-symbol">${element.symbol}</div>
                    <div class="element-name">${element.name}</div>
                `;
                elementButton.addEventListener('click', () => {
                    const newAtom = new Atom(lastCanvasClick.x, lastCanvasClick.y, element.symbol, element.stableIsotopes[0], element.color, element.maxBonds, element.halfLife || 0);
                    atoms.push(newAtom);
                    periodicTableModal.style.display = 'none'; // Close modal directly
                });
                periodicTableGrid.appendChild(elementButton);
            }
        }
    });
}

renderElements(); // Call renderElements to display the periodic table on load



class Atom {
    constructor(x, y, symbol, massNumber, color, maxBonds, halfLife = 0) {
        this.halfLife = halfLife;
        this.decayTimer = halfLife > 0 ? halfLife : 0; // Initialize decay timer if radioactive
        this.id = Math.random(); // Unique ID for each atom
        this.x = x;
        this.y = y;
        this.symbol = symbol;
        const elementData = elements.find(el => el.symbol === symbol);
        this.atomicNumber = elementData ? elementData.atomicNumber : 0;
        this.name = elementData ? elementData.name : "Unknown";
            this.massNumber = massNumber;
            this.radius = 15; // Placeholder radius
            this.color = color; // Use the passed color
            this.originalColor = color; // Store original color
            this.isUnstable = false; // New property to track instability
            this.unstableStartTime = null; // New property to store when instability started
            this.bondedTo = []; // Array to store bonded atoms and their constraints
        this.maxBonds = maxBonds; // Store element-specific max bonds
        this.halfLife = halfLife;
        this.decayTimer = 0;

        console.log("Atom constructor called:", { x, y, symbol, massNumber, color, maxBonds });
        console.log("Matter.js World and Bodies available:", !!World, !!Bodies);

        // Create a Matter.js circle body for the atom
        this.body = Bodies.circle(x, y, this.radius, {
            restitution: 0.8, // Bounciness
            friction: 0.01,   // Friction
            density: massNumber / 100, // Mass based on massNumber
            atomObject: this // Reference to the Atom object itself
        });
        World.add(world, this.body);
    }

    draw() {
        console.log("Atom draw method called for:", this.symbol);
        const pos = this.body.position;
        const angle = this.body.angle;

        ctx.save();
        ctx.translate(pos.x, pos.y);
        ctx.rotate(angle);

        ctx.beginPath();
        ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
        ctx.fillStyle = this.color;
        ctx.fill();
        ctx.strokeStyle = '#000000';
        ctx.lineWidth = 1;
        ctx.stroke();

        ctx.fillStyle = '#FFFFFF';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = 'bold 12px Arial';
        ctx.fillText(this.symbol, 0, 0);

        ctx.restore();

        // Draw bonds
        this.bondedTo.forEach(bond => {
            const otherAtomBody = bond.atom.body;
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
            ctx.lineTo(otherAtomBody.position.x, otherAtomBody.position.y);
            ctx.strokeStyle = bond.color;
            ctx.lineWidth = 2;
            ctx.stroke();
        });


    }
}

class RadioactiveParticle {
    constructor(x, y, parentAtomRadius) {
        this.id = Math.random();
        this.radius = parentAtomRadius * 0.3;
        this.color = 'green';
        this.isRadioactiveParticle = true; // Flag to identify this as a radioactive particle
        this.lifeTime = 5000; // 5 seconds
        this.creationTime = engine.timing.timestamp;

        this.body = Bodies.circle(x, y, this.radius, {
            restitution: 0.9,
            friction: 0.01,
            frictionAir: 0.001,
            density: 0.0001, // Very light
            collisionFilter: { category: particleCategory, mask: atomCategory }, // Only collides with atoms
        });
        this.body.particleObject = this; // Reference to the Particle object
        World.add(world, this.body);
    }

    draw() {
        ctx.beginPath();
        ctx.arc(this.body.position.x, this.body.position.y, this.radius, 0, 2 * Math.PI);
        ctx.fillStyle = this.color;
        ctx.fill();
    }
}




// Function to check for unstable molecules




// Helper function to calculate the distance from a point to a line segment


function applyCustomForces() {
    const atoms = currentAtoms; // Assuming currentAtoms holds all active atom objects

    for (let i = 0; i < atoms.length; i++) {
        for (let j = i + 1; j < atoms.length; j++) {
            const atomA = atoms[i];
            const atomB = atoms[j];

            // Skip if atoms are bonded
            if (atomA.bondedTo.some(bond => bond.atom === atomB) || atomB.bondedTo.some(bond => bond.atom === atomA)) {
                continue;
            }

            const bodyA = atomA.body;
            const bodyB = atomB.body;

            const distanceSq = Matter.Vector.magnitudeSquared(Matter.Vector.sub(bodyA.position, bodyB.position));
            const distance = Math.sqrt(distanceSq);

            // Define a threshold for interaction
            const interactionDistance = 100; // Adjust as needed

            if (distance < interactionDistance) {
                let forceMagnitude = 0;
                let forceDirection = Matter.Vector.normalise(Matter.Vector.sub(bodyB.position, bodyA.position));

                // Example: Repulsion for all atoms
                forceMagnitude = -0.00001 * (interactionDistance - distance); // Repulsive force

                // Example: Attraction for same element (adjust as needed)
                if (atomA.symbol === atomB.symbol) {
                    forceMagnitude += 0.000005 * (interactionDistance - distance); // Attractive force
                }

                const force = Matter.Vector.mult(forceDirection, forceMagnitude);

                Matter.Body.applyForce(bodyA, bodyA.position, Matter.Vector.neg(force));
                Matter.Body.applyForce(bodyB, bodyB.position, force);
            }
        }
    }
}

function getElementByAtomicNumber(atomicNumber) {
    return elements.find(el => el.atomicNumber === atomicNumber);
}

function decayAtom(atom) {
    decaySound.currentTime = 0;
    decaySound.play().catch(e => console.log("Decay sound play prevented:", e));
    const newAtomicNumber = atom.atomicNumber - 1;
    if (newAtomicNumber <= 0) { // Prevent atomic number from going below 1 (Hydrogen)
        // Remove the atom if it decays below Hydrogen
        World.remove(world, atom.body);
        atoms = atoms.filter(a => a !== atom);
        return;
    }

    const newElement = getElementByAtomicNumber(newAtomicNumber);
    if (newElement) {
        // Update atom properties
        atom.atomicNumber = newElement.atomicNumber;
        atom.symbol = newElement.symbol;
        atom.name = newElement.name;
        atom.color = newElement.color;
        atom.maxBonds = newElement.maxBonds;
        atom.halfLife = newElement.halfLife || 0;
        atom.decayTimer = newElement.halfLife || 0;

        // Break all existing bonds
        const bondsToBreak = [...atom.bondedTo];
        bondsToBreak.forEach(bondedAtom => {
            unbondAtoms(atom, bondedAtom.atom);
        });

        // Create and launch a radioactive particle
        const particle = new RadioactiveParticle(atom.body.position.x, atom.body.position.y, atom.radius);
        radioactiveParticles.push(particle);
        // Apply a random force to the particle
        const forceMagnitude = 0.00055;
        const angle = Math.random() * 2 * Math.PI;
        const force = { x: forceMagnitude * Math.cos(angle), y: forceMagnitude * Math.sin(angle) };
        Matter.Body.applyForce(particle.body, particle.body.position, force);
    }
}

function handleRadioactiveCollision(atom, particle) {

    // Break all bonds of the collided atom
    const bondsToBreak = [...atom.bondedTo];
    bondsToBreak.forEach(bondedAtom => {
        unbondAtoms(atom, bondedAtom.atom);
    });

    // Increase proton number and update atom properties
    const newAtomicNumber = atom.atomicNumber + 1;
    const newElement = getElementByAtomicNumber(newAtomicNumber);

    if (newElement) {
        atom.atomicNumber = newElement.atomicNumber;
        atom.symbol = newElement.symbol;
        atom.name = newElement.name;
        atom.color = newElement.color;
        atom.maxBonds = newElement.maxBonds;
        atom.halfLife = newElement.halfLife || 0;
        atom.decayTimer = newElement.halfLife || 0;
    } else {
        console.warn(`Could not find element for atomic number ${newAtomicNumber}. Atom will be removed.`);
        World.remove(world, atom.body);
        atoms = atoms.filter(a => a !== atom);
    }

    // Remove the radioactive particle from the world and the array
    World.remove(world, particle.body);
    radioactiveParticles = radioactiveParticles.filter(p => p !== particle);
}

function gameLoop() {
    Engine.update(engine, 1000 / 60); // Update physics engine at 60fps (keeps mouse movement active)
    if (!isPaused) {
        const deltaTime = 1000 / 60; // Assuming 60 FPS update rate
        applyCustomForces();


        // Radioactive decay logic
        atoms.forEach(atom => {
            if (atom.halfLife > 0) {
                atom.decayTimer -= deltaTime;
                if (atom.decayTimer <= 0) {
                    if (Math.random() < 0.5) { // 50% chance to decay
                        console.log(`Atom ${atom.symbol}-${atom.id} is decaying!`);
                        decayAtom(atom);
                    }
                    atom.decayTimer = atom.halfLife; // Reset timer regardless of decay for next half-life period
                }
            }
        });

        // Remove expired radioactive particles
        radioactiveParticles = radioactiveParticles.filter(particle => {
            if (engine.timing.timestamp - particle.creationTime > particle.lifeTime) {
                World.remove(world, particle.body);
                return false; // Remove from array
            }
            return true; // Keep in array
        });

        // Check for timed bond breaking of unstable molecules
        atoms.forEach(atom => {
            if (atom.isUnstable && (engine.timing.timestamp - atom.unstableStartTime) > DECAY_THRESHOLD_TIME) {
                console.log(`Unstable atom ${atom.symbol}-${atom.id} breaking bonds due to decay threshold! Unstable since: ${atom.unstableStartTime}, Current timestamp: ${engine.timing.timestamp}`);
                const bondsToBreak = [...atom.bondedTo];
                bondsToBreak.forEach(bondedAtom => {
                    unbondAtoms(atom, bondedAtom.atom);
                });
                atom.isUnstable = false;
                atom.unstableStartTime = null;
                console.log(`Atom ${atom.symbol}-${atom.id} is no longer unstable.`);
            }
        });
    }
    ctx.clearRect(0, 0, playarea.width, playarea.height);
    atoms.forEach(atom => atom.draw());
    radioactiveParticles.forEach(particle => particle.draw());
    requestAnimationFrame(gameLoop);
}


function bondAtoms(atomA, atomB) {
    const isAtomAReactive = REACTIVE_ELEMENTS.includes(atomA.symbol);
    const isAtomBReactive = REACTIVE_ELEMENTS.includes(atomB.symbol);

    if (!isAtomAReactive && !isAtomBReactive) {
        console.log(`Cannot bond ${atomA.symbol} and ${atomB.symbol}: neither is a reactive element.`);
        return;
    }
    // Check if atoms are already bonded
    if (atomA.bondedTo.some(bond => bond.atom === atomB)) {
        console.log(`Atoms ${atomA.symbol} and ${atomB.symbol} are already bonded.`);
        return;
    }

    // Check if either atom has reached its max bonds
    if (atomA.bondedTo.length >= atomA.maxBonds || atomB.bondedTo.length >= atomB.maxBonds) {
        console.log(`Cannot bond ${atomA.symbol} and ${atomB.symbol}: one or both have reached max bonds.`);
        return;
    }

    const constraint = Matter.Constraint.create({
        bodyA: atomA.body,
        bodyB: atomB.body,
        stiffness: 0.5,
        length: atomA.radius + atomB.radius
    });

    World.add(world, constraint);
    collisionSound.currentTime = 0;
    collisionSound.play().catch(e => console.log("Bonding sound play prevented:", e));
    atomA.bondedTo.push({ atom: atomB, constraint: constraint, color: DEFAULT_BOND_COLOR });
    atomB.bondedTo.push({ atom: atomA, constraint: constraint, color: DEFAULT_BOND_COLOR });
    console.log(`Bonded ${atomA.symbol} and ${atomB.symbol}`);
    checkMoleculeStability(atomA);
    checkMoleculeStability(atomB);
}

function checkMoleculeStability(initialAtom) {
    const moleculeAtoms = new Set();
    const queue = [initialAtom];
    const visited = new Set();

    while (queue.length > 0) {
        const currentAtom = queue.shift();
        if (visited.has(currentAtom)) continue;
        visited.add(currentAtom);
        moleculeAtoms.add(currentAtom);

        currentAtom.bondedTo.forEach(bond => {
            if (!visited.has(bond.atom)) {
                queue.push(bond.atom);
            }
        });
    }

    let totalFreeBonds = 0;
    moleculeAtoms.forEach(atom => {
        totalFreeBonds += (atom.maxBonds - atom.bondedTo.length);
    });

    let isHomoatomic = true;
    if (moleculeAtoms.size > 0) {
        const firstAtomSymbol = initialAtom.symbol;
        for (const atom of moleculeAtoms) {
            if (atom.symbol !== firstAtomSymbol) {
                isHomoatomic = false;
                break;
            }
        }
    }

    let isMoleculeUnstable = false;
    if (!isHomoatomic) {
        isMoleculeUnstable = totalFreeBonds > FREE_BONDS_THRESHOLD;
    }

    moleculeAtoms.forEach(atom => {
        if (isMoleculeUnstable) {
            if (!atom.isUnstable) {
                atom.isUnstable = true;
                atom.unstableStartTime = engine.timing.timestamp;
                console.log(`Molecule containing ${atom.symbol}-${atom.id} is now unstable with ${totalFreeBonds} total free bonds.`);
            }
        } else {
            if (atom.isUnstable) {
                atom.isUnstable = false;
                atom.unstableStartTime = null;
                console.log(`Molecule containing ${atom.symbol}-${atom.id} is now stable with ${totalFreeBonds} total free bonds.`);
            }
        }
    });
}

function unbondAtoms(atomA, atomB) {
    console.log(`Attempting to unbond ${atomA.symbol}-${atomA.id} and ${atomB.symbol}-${atomB.id}`);
    const bondA = atomA.bondedTo.find(bond => bond.atom === atomB);
    const bondB = atomB.bondedTo.find(bond => bond.atom === atomA);

    if (bondA && bondB && bondA.constraint === bondB.constraint) {
        World.remove(world, bondA.constraint);
        unbondSound.currentTime = 0;
        unbondSound.play().catch(e => console.log("Unbonding sound play prevented:", e));
        atomA.bondedTo = atomA.bondedTo.filter(bond => bond.atom !== atomB);
        atomB.bondedTo = atomB.bondedTo.filter(bond => bond.atom !== atomA);
        console.log(`Successfully unbonded ${atomA.symbol}-${atomA.id} and ${atomB.symbol}-${atomB.id}`);
    } else {
        console.log(`No bond found between ${atomA.symbol}-${atomA.id} and ${atomB.symbol}-${atomB.id} or bond mismatch.`);
    }
    checkMoleculeStability(atomA);
    checkMoleculeStability(atomB);
}

const DEFAULT_BOND_COLOR = '#000000'; // Black
const FREE_BONDS_THRESHOLD = 4;
const DECAY_THRESHOLD_TIME = 5000; // 5 seconds in milliseconds
const REACTIVE_ELEMENTS = ['H', 'O', 'F', 'Cl', 'N', 'Br', 'C', 'S']; // If a molecule has more than this many free bonds, it becomes unstable

function applyCustomForces() {
    const attractionStrength = 0.0001; // Adjust as needed
    const repulsionStrength = 0.001; // Adjust as needed
    const attractionDistance = 200; // Distance for attraction to start
    const repulsionDistance = 100; // Distance for repulsion to start (slightly more than atom radius * 2)

    for (let i = 0; i < atoms.length; i++) {
        for (let j = i + 1; j < atoms.length; j++) {
            const atomA = atoms[i];
            const atomB = atoms[j];

            // Only apply custom forces between atoms of the same element that are not already bonded
            if (atomA.symbol === atomB.symbol && !atomA.bondedTo.some(bond => bond.atom === atomB)) {
                const distance = Matter.Vector.magnitude(Matter.Vector.sub(atomA.body.position, atomB.body.position));

                if (distance > repulsionDistance && distance < attractionDistance) {
                    // Apply attraction force
                    const forceMagnitude = attractionStrength * (attractionDistance - distance);
                    const forceVector = Matter.Vector.normalise(Matter.Vector.sub(atomB.body.position, atomA.body.position));
                    Matter.Body.applyForce(atomA.body, atomA.body.position, { x: forceVector.x * forceMagnitude, y: forceVector.y * forceMagnitude });
                    Matter.Body.applyForce(atomB.body, atomB.body.position, { x: -forceVector.x * forceMagnitude, y: -forceVector.y * forceMagnitude });
                } else if (distance < repulsionDistance) {
                    // Apply repulsion force
                    const forceMagnitude = repulsionStrength * (repulsionDistance - distance);
                    const forceVector = Matter.Vector.normalise(Matter.Vector.sub(atomA.body.position, atomB.body.position));
                    Matter.Body.applyForce(atomA.body, atomA.body.position, { x: forceVector.x * forceMagnitude, y: forceVector.y * forceMagnitude });
                    Matter.Body.applyForce(atomB.body, atomB.body.position, { x: -forceVector.x * forceMagnitude, y: -forceVector.y * forceMagnitude });
                }
            }
        }
    }
}

Matter.Events.on(engine, 'collisionStart', (event) => {
    const pairs = event.pairs;
    pairs.forEach(pair => {
        const { bodyA, bodyB } = pair;
        // Check if both bodies are atoms
        if (bodyA.atom && bodyB.atom) {
            bondAtoms(bodyA.atom, bodyB.atom);
        }
    });
});

renderElements();

gameLoop();


</script>
</body>
</html